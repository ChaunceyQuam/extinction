---
title: "The Sixth Mass Extinctions"
author: "Alice Hua, Chancey Quam"
maketitle: true
output: github_document
---

```{r include=FALSE}
library("tidyverse")
library("httr")
library("jsonlite")
library("tidyverse")
library("stringr")
library("rlang")
library("ggplot2")
#library("printr")
knitr::opts_chunk$set(comment=NA)
```

## Mass Extinctions Module

_Are we experiencing the sixth great extinction?_  

What is the current pace of extinction? Is it accelerating? How does it compare to background extinction rates?

## Background

- [Section Intro Video](https://youtu.be/QsH6ytm89GI)
- [Ceballos et al (2015)](http://doi.org/10.1126/sciadv.1400253)

Our focal task will be to reproduce the result from Ceballos and colleagues showing the recent increase in extinction rates relative to the background rate: 

![](https://espm-157.carlboettiger.info/img/extinctions.jpg)


## Computational Topics

- Accessing data from a RESTful API
- Error handling
- JSON data format
- Regular expressions
- Working with missing values

## Additional references:

- http://www.hhmi.org/biointeractive/biodiversity-age-humans (Video)
- [Barnosky et al. (2011)](http://doi.org/10.1038/nature09678)
- [Pimm et al (2014)](http://doi.org/10.1126/science.1246752)
- [Sandom et al (2014)](http://dx.doi.org/10.1098/rspb.2013.3254)

### Data about the species:

Here we use RESTful API to read in data about all species evaluated by the IUCN Red List.
```{r}
species_ap <- "https://apiv3.iucnredlist.org/api/v3/species"
page <- "/page/"
page_number <- 0:10
query <- "?token="
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"

#write a function to get http, clue everything together to make a url that iterates over the vector of page_number
all_pages <- paste0(species_ap, page, page_number, query, token)
```

We will get the results for all 10 pages, each has 10,000 records of all species published. 
```{r all_results, cache = TRUE}
#apply map to all_pages a vector
all_results <- map(all_pages, GET)
```

Let's look at the names of the data.
```{r}
row <- all_results[[1]] %>% content() %>% getElement("result") %>% getElement(1)
names(row)
```

Using the names we got above, here we turn the data into "rectangle" as a dataframe. According to the paper by Ceballos on species extinctions, Both extinct species and extinct in the wild species were selected to make their final graph. To reproduce their result, we are filtering to have only species under the two categories. 
```{r}
row_to_tibble <- function(row){
  tibble(scientific_name = row$scientific_name, 
         category = row$category, 
         phylum = row$phylum_name,
         class = row$class_name)
}

get_result <- function(x){
  x %>% content() %>% getElement("result") %>% 
  map_dfr(row_to_tibble)
}
```
```{r}
all_species <- all_results  %>% map_dfr(get_result) %>% filter(category=="EX"| category=="EW")
all_species
```

We can see that 989 species went extinct or extinct in the wild. Let's see the unique phylums of species. For the purpose of this study, we will select only the species of Chordata phylum because they are vertebrates.
```{r}
unique(all_species$phylum)
```

### Data about the species extinction dates:

Lets get the extinction dates for these species. The data is store in the narrative text for each species. Again, we are setting up the url to be called in the RESTful API.
```{r}
#setting the species table individually
all_extinct <- all_species %>% pull(scientific_name)

#variables of a url
base <- "https://apiv3.iucnredlist.org"
narrative <- "/api/v3/species/narrative/"
name_group1 <- all_extinct
query <- "?token="
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"
url <- paste0(base, narrative, name_group1, query, token)
```

We have already called the urls for all the extinct species (this will take awhile) and saved it as an R object RDS. The code chunk below will load the object if the file exists or it will download the data if the file doesn't exist. Then this object consists of all extinct and extinct in the wild species is read into all_data.
```{r}
if (!file.exists("massive_resp.rds")){
  resp <- map(url, GET)
  saveRDS(resp, "massive_resp.rds")
} else {
  all_data <- readRDS("massive_resp.rds")
}
```

We will need to get the rationale section for each species in order to find out what date they went extinct. 
Here are the narratives of the species, the narratives that are NULL are stored as NA.
```{r cache=TRUE}
map_chr_na <- possibly(map_chr, as.character(NA))

narrative <- all_data %>% map(content) %>% map("result") %>% 
  map(map_chr_na, "rationale")
```

This is an example of how one species can have more than 1 string paragraph of narrative. This will need to deal with in the next step.
```{r}
(map_int(narrative, length) >1) %>% which()
narrative[666]
```

Lets extract the extinction date for species that have dates in their narrative. We created a custom function to extract any 4 digit number from the rationales. We then unlist them as they are nested in lists as we have seen above.
```{r}
extinc_year <- map(narrative, function(x){
  str_extract_all(x, "\\d{4}") %>% 
  unlist()
}) 
```

We will bin the years for all species into the specific bins for our final graph. Since we are using bins of interval 100 years. It is reasonable to put them in these bins. 
For rationales of species that contain more than one year, if the years are within the 100-year interval, we will collapse them into the same bin. If they are not within the 100-year interval however, we will select the latest year and put it in the corresponding bin. We chose to do so because we observed that the narratives have a tendency to list the last seen date as the date of approximate extinction.
Lastly, if there is no narrative, or Null values, we will give them NA as values. 
```{r}
bin_year <- function(x) {
  x = as.integer(x)
    case_when(
      between(x, 1500, 1600) ~ "1600",
      between(x, 1600, 1700) ~ "1700",
      between(x, 1700, 1800) ~ "1800",
      between(x, 1800, 1900) ~ "1900",
      between(x, 1900, 2020) ~ "2000",
      !between(x, 1500, 2020) ~ as.character("not a year"),
      length(x) < 1 ~ as.character(NA)) %>%
      unique() %>%
      max()
}
```

Here we apply our binning function to all the years that we extracted from the species rationale to come up an extinction date for each species.
It is important to note that we assigned all null narratives which were replaced to NAs by our binning function earlier to have 1600 as its values. This is because we will calculate the cumulative sum for each group of species, the cumulative sum would start at the beginning and continue to the latest year, which means that all the species of null dates will get counted from the beginning of our time series and continued to be counted to the end. This would be our maximum possible species that have gone extinct. 

```{r warning=FALSE}
all_year <- 
  extinc_year %>% 
  map(possibly(bin_year, NA_real_)) %>%
  as.integer() %>% 
  replace_na(1600)
```

Here are are adding the dates of 989 extinct dates that we derived from the narratives earlier to the table of 989 species from our initial species table which consists of EX - Extinct and EW - Extinct in the Wild species.
```{r}
all_species_with_year <- all_species %>%
  mutate(extinct_year = all_year)
all_species_with_year
```

To reproduce a similar result to Cellabos's final graph, we did the following -
We sorted the species with extinction dates into 4 different groups: Mammals, Birds, Vertebrates and Other Vertebrates. 
We included Mammals, Birds and Amphibians in the Vertebrates group. For the Other Vertebrates group we excluded Mammals and Birds and included all species in the Chordata phylum, which includes all other vertebrates. 
```{r}
verte <- c("MAMMALIA","AVES","AMPHIBIA")

birds <- all_species_with_year %>% 
  filter(class == "AVES") %>% mutate(group = "Birds")

mammals <- all_species_with_year %>% 
  filter(class == "MAMMALIA") %>% mutate(group = "Mammals")

vertebrate <- all_species_with_year %>% 
  filter(class %in% verte) %>% mutate(group = "Vertebrate")

all_others <- all_species_with_year %>% 
  filter(phylum == "CHORDATA") %>% 
  filter(!class %in% c("MAMMALIA", "AVES")) %>% 
  mutate(group = "Other Vertebrates")
```

We calculate the cumulative sums for each group. 
```{r}
count_sum <- function(table) {
  new_table <- table %>%
  group_by(extinct_year, group)%>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(cum_sum = cumsum(count))
  return(new_table)
}

birds_sum <- count_sum(birds)
mam_sum <- count_sum(mammals)
vert_sum <- count_sum(vertebrate)
other_sum <- count_sum(all_others)

all_types <- rbind(birds_sum, mam_sum, vert_sum, other_sum)
all_types
```

Now, we also need to get the total of all species for each class, this will be our denominator for the percentage calculation at the end.
```{r all_species_eval, cache = TRUE}
all_species_eval <-all_results  %>% map_dfr(get_result)

birds_total  <- birds <- all_species_eval %>% 
  filter(class == "AVES") %>% mutate(group = "Birds")

mammal_total <- mammals <- all_species_eval %>% 
  filter(class == "MAMMALIA") %>% mutate(group = "Mammals")

vert_total <- vertebrate <- all_species_eval %>% 
  filter(class %in% verte) %>% mutate(group = "Vertebrate")

other_total <- all_others <- all_species_eval %>% 
  filter(phylum == "CHORDATA") %>% 
  filter(!class %in% c("MAMMALIA", "AVES")) %>% 
  mutate(group = "Other Vertebrates")
  
```

Tn order to arrive at the fractions of accumulative extinctions as percentages of IUCN-evaluated species, we need to divide the total of a species of each group in each bin to the total number of that species.
To get each special total count, we made a new table to have only total counts for 4 groups (birds, mammals, vertebrate, other vertebrates). 
We joined this table to our current master extict table to create another more comprehensive table. With the total counts and species count per bin year, we can arrive at the fraction desired. 
```{r}
group_total <- data.frame(group = 
                                  c("Birds", "Mammals", "Vertebrate", "Other Vertebrates"),                                    
                          sum_species = 
                                  c(nrow(birds_total), nrow(mammal_total),                                                      nrow(vert_total),nrow(other_total)))

master_ex_table <- all_types %>%
  left_join(group_total) %>%
  mutate(perc_ex_withNA = 100*(cum_sum/ sum_species))
master_ex_table
```

Lets' visualize the highest possible extinction that we calculated by including NA dates in the year bin of 1600.
```{r}
master_ex_table %>% ggplot(aes(x = factor(extinct_year), group = group, color = group)) +
  geom_line(aes(y = perc_ex_withNA), lwd = 1.5) +
  labs(title = "Cumulative Vertebrate Species as EX or EW by the IUCN 2019",
       y = 'Cumulative extinctions as % of UCN-evaluated species',
       x = "Time interval") + 
  scale_x_discrete(labels=c("1500-1600", "1600-1700", "1700-1800", "1800-1900", "1900-2000")) +
  scale_y_continuous(breaks = seq(0,2, by=0.2)) +
  theme_classic() +
  theme(text = element_text(size=10))
    
```

Comparing to the Fig. 1 graph in Ceballos's paper, we see that the graph was made using data as of 2012. It has been almost 8 years since then. Our graph is reflecting the changes in the extinction rates. We see an elevated rate of extinction for vertebrates when we include the data from recent years. 
However, this is the maximum of veterbrate extinctions with N.A values for extinction dates counted.
Now, We want to reproduce the data without the NA values to see the difference.
```{r}
all_year_noNA <- 
  extinc_year %>% 
  map(possibly(bin_year, NA_real_)) %>%
  as.integer()

all_species_noNA <- all_species %>%
  mutate(extinct_year = all_year_noNA) %>%
  drop_na()
all_species_noNA

```
```{r}

birds_noNa <- all_species_noNA %>% 
  filter(class == "AVES") %>% mutate(group = "Birds")

mammals_noNa <- all_species_noNA %>% 
  filter(class == "MAMMALIA") %>% mutate(group = "Mammals")

vertebrate_noNa <- all_species_noNA %>% 
  filter(class %in% verte) %>% mutate(group = "Vertebrate")

all_others_noNa <- all_species_noNA %>% 
  filter(phylum == "CHORDATA") %>% 
  filter(!class %in% c("MAMMALIA", "AVES")) %>% 
  mutate(group = "Other Vertebrates")
```

We calculate the cumulative sums for each group, excluding any NA value for extinction year. We will add our results into the master table with the percentages calculated with NA values included.
```{r}
birds_sum_noNa <- count_sum(birds_noNa)
mam_sum_noNa <- count_sum(mammals_noNa)
vert_sum_noNa <- count_sum(vertebrate_noNa)
other_sum_noNa <- count_sum(all_others_noNa)

all_types_noNa <- rbind(birds_sum_noNa, mam_sum_noNa, vert_sum_noNa, other_sum_noNa)

master_noNA<- all_types_noNa %>%
  left_join(group_total) %>%
  mutate(perc_extinct_noNA = 100*(cum_sum/ sum_species))

master_ex_table <- master_ex_table %>%
  mutate(perc_ex_noNA = master_noNA$perc_extinct_noNA)
master_ex_table
```

Lets' visualize the extinction percentages that we calculated excluding extinction records that had NA values for extinction dates.
```{r}
master_ex_table %>% ggplot(aes(x = factor(extinct_year), group = group, color = group)) +
  geom_line(aes(y = perc_extinct_withNA), lwd = 1.5) +
  geom_line(aes(y = perc_ex_noNA), linetype = "dashed") +
  labs(title = "Cumulative Vertebrate Species as EX or EW by the IUCN 2019",
       y = 'Cumulative extinctions as % of UCN-evaluated species',
       x = "Time interval") + 
  scale_x_discrete(labels=c("1500-1600", "1600-1700", "1700-1800", "1800-1900", "1900-2000")) +
  scale_y_continuous(breaks = seq(0,2, by=0.2)) +
  theme_classic() +
  theme(text = element_text(size=10))
    
```

The graph above shows the highest and lowest possible extinction percentages for all veterbrates. The solid lines represent the highest values which were generated by including NAs in our initial year bin. The dashed lines represent the lowest values which were generated by excluding NAs.
We think that the real percentages of extinction are somewhere in between these two lines for each group of species. 
To do so, we will take interpolate the extinction percentages for the vertebrates that have NA values for their extinction dates. We start with finding the total number of extinctions of NA dates. 

Here is the total number of extinctions that did not have an extinction date.  We see that this value is close to half of our total count of extinct species, meaning we only know the extinction date for slightly over 50% of our extinct species. If we were to leave the species with NA dates out of our final conclusion, that would tell an unaccurate story of the verterbrate extinctions overall.
```{r}
na_total <- nrow(all_species_with_year) - nrow(all_species_noNA)
na_total
```


```{r}
year_group <- master_noNA %>% arrange(extinct_year) %>%
  select(extinct_year, count, group) %>%
  group_by(extinct_year, group) %>%
  summarise(noNA_total= sum(count)) %>%
  mutate(noNA_percent = (noNA_total/nrow(all_species_noNA))) %>%
  mutate(NA_derived_count = noNA_percent * na_total) %>% 
  select(group, NA_derived_count)
year_group
```

 
```{r}
uncertain_perc <- master_noNA %>% 
  left_join(year_group) %>%
  mutate(count_low_NA = count + NA_derived_count) %>%
  group_by(extinct_year, group) %>%
  summarize(cumsum_lowNA = cumsum(count_low_NA))

master_ex_table <- master_ex_table %>%
  left_join(uncertain_perc) %>%
  mutate(perc_ex_uncertain = 100*(cumsum_lowNA/sum_species))
master_ex_table
```

```{r}
master_ex_table %>% filter(group =="Birds") %>% 
  ggplot(aes(x = factor(extinct_year), group = group)) +
  geom_line(aes(y = perc_ex_withNA), linetype = "dotdash", lwd=1.2, color = "blue") +
  geom_line(aes(y = perc_ex_noNA), linetype = "dashed", color= "red") +
  geom_line(aes(y = perc_ex_uncertain), linetype = "solid", lwd = 1) +
  labs(title = "Cumulative Vertebrate Species as EX or EW by the IUCN 2019",
       y = 'Cumulative extinctions as % of UCN-evaluated species',
       x = "Time interval") + 
  scale_x_discrete(labels=c("1500-1600", "1600-1700", "1700-1800", "1800-1900", "1900-2000")) +
  scale_y_continuous(breaks = seq(0,2, by=0.2)) +
  theme_classic() +
  theme(text = element_text(size=10))
```


The background rate used by Gerardo Ceballos is 2 mammal extinctions per 10,000 species per 100 years (2E/MSY). The modern extinction rate is 100 times higher than this background rate. 

We can compare the rates of extinction between using "EX" = "extinction" category and "EW" = "extinction in the wild" and "PE" = "possibly extinct"






