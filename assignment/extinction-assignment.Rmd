---
title: "Extinctions Unit"
author: "Alice Hua, Chancey Quam"
maketitle: true
output: github_document
---



```{r include=FALSE}
library("tidyverse")
library("httr")
library("jsonlite")
library("tidyverse")
#library("printr")
knitr::opts_chunk$set(comment=NA)
```



## Extinctions Module

_Are we experiencing the sixth great extinction?_  

What is the current pace of extinction? Is it accelerating? How does it compare to background extinction rates?

## Background

- [Section Intro Video](https://youtu.be/QsH6ytm89GI)
- [Ceballos et al (2015)](http://doi.org/10.1126/sciadv.1400253)

Our focal task will be to reproduce the result from Ceballos and colleagues showing the recent increase in extinction rates relative to the background rate:

![](https://espm-157.carlboettiger.info/img/extinctions.jpg)


## Computational Topics

- Accessing data from a RESTful API
- Error handling
- JSON data format
- Regular expressions
- Working with missing values

## Additional references:

- http://www.hhmi.org/biointeractive/biodiversity-age-humans (Video)
- [Barnosky et al. (2011)](http://doi.org/10.1038/nature09678)
- [Pimm et al (2014)](http://doi.org/10.1126/science.1246752)
- [Sandom et al (2014)](http://dx.doi.org/10.1098/rspb.2013.3254)

```{r}
species <- httr::GET("https://apiv3.iucnredlist.org/api/v3/species/page/0?token=9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee")
page0 <- content(species)
```

Reading in data
```{r}
species_ap <- "https://apiv3.iucnredlist.org/api/v3/species"
page <- "/page/"
page_number <- 0:10
query <- "?token="
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"

#write a function to get http, clue everything together to make a url that iterates over the vector of page_number
all_pages <- paste0(species_ap, page, page_number, query, token)


#apply map to all_pages a vector
all_results <- map(all_pages, GET)
```

```{r}
row <- all_results[[1]] %>% content() %>% getElement("result") %>% getElement(1)
names(row)
```

Turning data into "rectangle"  as data.frame and find species categorized under extinction
```{r}
row_to_tibble <- function(row){
  tibble(scientific_name = row$scientific_name, 
         category = row$category, 
         class = row$class_name)
}

get_result <- function(x){
  x %>% content() %>% getElement("result") %>% 
  map_dfr(row_to_tibble)
}

all_species <- all_results  %>% map_dfr(get_result)
all_species
```

Let's see the unique classes of species
```{r}
unique(all_species$class)
```


Lets get the narrative text for each species listed as extinct
```{r}
#setting the species table individually
all_extinct_mammal_bird <- all_species %>% filter(category=="EX") %>% filter(class == "AVES") %>% pull(scientific_name)

#variables of a url
base <- "https://apiv3.iucnredlist.org"
narrative <- "/api/v3/species/narrative/"
name_group1 <- all_extinct_mammal_bird
query <- "?token="
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"
url <- paste0(base, narrative, name_group1, query, token)

sleep_func <- function(url){
  Sys.sleep(0.1)
  GET(url)
}

row_to_tibble_1 <- function(row){
  tibble(extinction_year = row$rationale)
}

get_result <- function(x){
  x %>% content() %>% getElement("result") %>%
    map_dfr(row_to_tibble_1)
}


num_bird <- nrow(all_extinct_mammal_bird <- all_species %>% filter(category=="EX") %>% filter(class == "AVES"))
num_mammal <- nrow(all_extinct_mammal_bird <- all_species %>% filter(category=="EX") %>% filter(class == "MAMMALIA"))
num_vert <- nrow(all_extinct_mammal_bird <- all_species %>% filter(category=="EX"))
other_vert <- num_vert -(num_bird + num_mammal)

```

```{r}
all_extinct <- all_species %>% filter(category=="EX") %>% filter(class == "AVES") %>% pull(scientific_name)

#variables of a url
base <- "https://apiv3.iucnredlist.org"
narrative <- "/api/v3/species/narrative/"
name_group1 <- all_extinct
query <- "?token="
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"
url <- paste0(base, narrative, name_group1, query, token)

resp <- map(url[1:10], sleep_func)
map_chr_na <- possibly(map_chr, as.character(NA))

json <- resp %>% map(content) %>% map("result") %>% 
  map(map_chr_na, "rationale")

json
```



```{r}
content(GET(url[1])) %>% getElement("result") %>% map_dfr(row_to_tibble_1)

```

Let's get the narrative for the birds and mammals
```{r}
narrative_group1 <- map(url[1:10], sleep_func)
is_error <- narrative_group1 %>% map_lgl(http_error)
good_narrative <- narrative_group1[!is_error]
extinct_table <- good_narrative %>% map_dfr(possibly(get_result, NA))

```
```{r}

```

Lets' look at the date that they go extinct
```{r}
stringr::str_extract_all(json, pattern = "\\d\\d\\d\\d")


```
```{r}
text %>% 
stringr::str_extract_all("\\d\\d\\d\\d")
```

